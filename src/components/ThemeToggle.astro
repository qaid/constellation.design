<div class="theme-toggle" data-theme-toggle>
  <button class="theme-toggle__btn" type="button" data-theme-toggle-btn aria-label="Theme" title="Theme">
    <span class="theme-toggle__icon theme-toggle__icon--light" aria-hidden="true">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="4" />
        <path d="M12 2v2" />
        <path d="M12 20v2" />
        <path d="M4.93 4.93l1.41 1.41" />
        <path d="M17.66 17.66l1.41 1.41" />
        <path d="M2 12h2" />
        <path d="M20 12h2" />
        <path d="M4.93 19.07l1.41-1.41" />
        <path d="M17.66 6.34l1.41-1.41" />
      </svg>
    </span>
    <span class="theme-toggle__icon theme-toggle__icon--dark" aria-hidden="true">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
      </svg>
    </span>
  </button>
</div>

<style>
  .theme-toggle {
    display: inline-flex;
    align-items: center;
    padding: 0;
  }

  .theme-toggle__btn {
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    color: var(--color-text-secondary);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: color var(--transition-fast), background-color var(--transition-fast);
  }

  .theme-toggle__btn:hover {
    color: var(--color-text-primary);
  }

  .theme-toggle__icon {
    display: none;
    line-height: 0;
  }

  .theme-toggle__btn[data-mode="light"] .theme-toggle__icon--light {
    display: block;
  }

  .theme-toggle__btn[data-mode="dark"] .theme-toggle__icon--dark {
    display: block;
  }

  .theme-toggle__btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
</style>

<script>
  const toggles = document.querySelectorAll('[data-theme-toggle]');

  type Mode = 'system' | 'light' | 'dark';
  type ResolvedMode = 'light' | 'dark';

  const normalizeMode = (mode: string | null | undefined): Mode => {
    if (mode === 'system' || mode === 'light' || mode === 'dark') return mode;
    return 'system';
  };

  const getMode = () => {
    if (typeof window.__getThemeMode === 'function') return normalizeMode(window.__getThemeMode());
    try {
      return normalizeMode(localStorage.getItem('theme'));
    } catch {
      return 'system';
    }
  };

  const setMode = (mode: Mode) => {
    if (typeof window.__setThemeMode === 'function') return window.__setThemeMode(mode);
    try {
      localStorage.setItem('theme', mode);
    } catch {}
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.dataset.theme = mode === 'system' ? (systemDark ? 'dark' : 'light') : mode;
    document.documentElement.dataset.themeMode = mode;
    window.dispatchEvent(new Event('themechange'));
  };

  const getResolvedMode = (): ResolvedMode => {
    const current = document.documentElement.dataset.theme;
    return current === 'dark' ? 'dark' : 'light';
  };

  const sync = (root: Element) => {
    const current = getResolvedMode();
    const btn = root.querySelector('[data-theme-toggle-btn]') as HTMLButtonElement | null;
    if (!btn) return;
    btn.setAttribute('data-mode', current);
    const label = `Theme: ${current.charAt(0).toUpperCase()}${current.slice(1)}`;
    btn.setAttribute('aria-label', label);
    btn.setAttribute('title', label);
  };

  toggles.forEach((root) => {
    sync(root);

    const btn = root.querySelector('[data-theme-toggle-btn]') as HTMLButtonElement | null;
    if (!btn) return;

    btn.addEventListener('click', () => {
      const resolved = getResolvedMode();
      const next: ResolvedMode = resolved === 'dark' ? 'light' : 'dark';
      setMode(next);
      sync(root);
    });
  });

  window.addEventListener('themechange', () => {
    toggles.forEach((root) => sync(root));
  });
</script>
